dist: bionic
language: go
os: linux

services:
  - docker

go:
  - 1.16.x
  - tip

jobs:
  fast_finish: true
  allow_failures:
    - go: tip

go_import_path: github.com/percona/pmm-admin

# skip non-trunk PMM-XXXX branch builds, but still build pull requests
branches:
  except:
    - /^PMM\-\d{4}/

cache:
  directories:
    - /home/travis/.cache/go-build
    # - /home/travis/gopath/pkg

before_cache:
  - go clean -testcache
  # - go clean -cache

env:
  global:
    - CODECOV_ENV=PMM_SERVER_IMAGE
    # REVIEWDOG_GITHUB_API_TOKEN
    - secure: "d7wrZeZWD6fYyUVbu2/p/QqCTs6isXfAyV8uUOZeb+qnKxYAz56URVwiZTmZW4zWSR3dpe81RmAtAJRGQa0LOBeoqkdjBiO38PQylbLO4rbQrC/I+4q3/BqN4GKIuPcX0eCNNNw7qryz/Dx3n8tm6D179y/Ilc8vCOo6EHRawPNHvdA10OsBdL6WfSfEVx69FRqz39dgaqeZxM/w3d5ra32s+mVsn0ja+gtGJFg+qzI/nHyN90Pkn6XweED/Pn3YAjrK+bEkTCJ53RbnNZf+/80p386VnrrhTKuEBE15DOtKQKINPcG+8C1n46sDD6VBUWAO3MI5BjYwXgTIZCGsHDnEzR7n6yUIsfhc2497xuqc+auKjUlrcafTPZTnBf74OY5mx0w+4hWn8qkC3Z03oNZfHhx/yGz8h8aEQBAoBigVKGc5qInD4AlEu692061IsIvWqmvU/rgiyiFuwLqFBt2+ivi3XrukI+DthWTlyF0nRuLyxoRojQ1/1VLDNL+s1KAVWjuZySvBH4tmslGeFgDTbcs3RcQxzZIC8aBAIuEecibiPY7bUwdNc9lr/JKXFLwrnK0yvLePGD5rBQc3K3lZdUYnabuGRekfUOsLmYsT62kME/DpPruuUa7Al0/YHXahC2lYFCV3rcopUXVeyDvK3zGMRDnFtQVU4rcVtAQ="
  matrix:
    - PMM_SERVER_IMAGE=percona/pmm-server:2.0.0
    - PMM_SERVER_IMAGE=percona/pmm-server:2
    - PMM_SERVER_IMAGE=public.ecr.aws/e7j3v3n0/pmm-server:dev-latest

before_install:
  - docker-compose up -d

install: skip
before_script:
  # ensure that files are not changed
  - make init
  - make format
  - git status
  - git diff --exit-code

script:
  # static analyze
  - make ci-reviewdog
  # for main_test.go
  - make install

  - make test-cover
  - make test-crosscover
  - make test-race

  - make check

after_success:
  - curl https://codecov.io/bash > codecov
  - chmod +x codecov
  - ./codecov -f cover.out -F cover -X fix
  - ./codecov -f crosscover.out -F crosscover -X fix

notifications:
  slack:
    on_success: change
    on_failure: always
    rooms:
      - secure: f6yNYYYyybz2iZn4QIIvQ9xJiKWEbOk9vJaobxUACouj01u2Ug9jJ0m/6lLPqRqKHg2qYpF67ffVfmFIbDNvRVQxUJHNGX85qwKqZaVHdzGtZgbvp2V+0XTIFS5PgZ8CvTRHIaawxRI8VPYIKxQNC8ytGrjId2tiwHyvk7RpW3B8uIpMmGc4SKetWQfaLIPwAUdS096y+ASiTZeeJA5eqryewz6FgHBO5tX5nz/zlGnz7cpzn71F5JLGTMEuQmv6+oUQuq6M5BTV0bO8sKDObDY1c6CVYk7cXQtd5bFk483o82Yu9fleH8ClT2YaltaCxQOfw59vyDQND8I+kAgOq05g8+WytKZnDrrqB/lsFk0SLW5C9jtu2NBV5T7EWG/9vpU6W3jZxJthrhd1KxUt03ymyg62puvmYTpttvuQVDQt8y2lCMRZj9WW5SicclKXEWbzUuhPLyJWI5mztws7hGp2qnj9IAye9GelbzT4INCWto7m1g2wETT3AYjKcdqFa0h7t/u+jJ6eq3RjxeFLmzFPIgyDbzwyE2GN77gzezVDkTxfeeSv63d2AziSXNs4dJaxQXf2oL04rCxckP8VTyX8O1iOdWF6A9OXwWsBjCZJJiJ1PBHEL7nnkVnpycRE6of6sSbX4vNtQv7eclqHHuUUYnlPXPeYA7Lh1XIJE1A=
